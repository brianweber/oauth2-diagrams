<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2676px" preserveAspectRatio="none" style="width:1460px;height:2676px;background:#FFFFFF;" version="1.1" viewBox="0 0 1460 2676" width="1460px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="2664.7372" style="stroke:#181818;stroke-width:0.5;" width="556.5" x="181.5" y="6"/><rect fill="none" height="633.9263" style="stroke:#000000;stroke-width:1.5;" width="884.5" x="90.5" y="221.2539"/><rect fill="none" height="288.4722" style="stroke:#000000;stroke-width:1.5;" width="840.5" x="109.5" y="404.4719"/><rect fill="none" height="272.4722" style="stroke:#000000;stroke-width:1.5;" width="861" x="109.5" y="1222.7704"/><rect fill="none" height="83.118" style="stroke:#000000;stroke-width:1.5;" width="423" x="631" y="1513.2426"/><rect fill="none" height="234.7662" style="stroke:#000000;stroke-width:1.5;" width="1200" x="109.5" y="2096.187"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="125.5" x2="125.5" y1="108.1358" y2="2566.6013"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="267" x2="267" y1="108.1358" y2="2566.6013"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="417" x2="417" y1="108.1358" y2="2566.6013"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="641" x2="641" y1="108.1358" y2="2566.6013"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="842.5" x2="842.5" y1="108.1358" y2="2566.6013"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1293.5" x2="1293.5" y1="108.1358" y2="2566.6013"/><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="75.5" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="106" y="76.9659">Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="82.5" y="96.0339">https://client</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="185.5" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="192.5" y="76.9659">User Agent / Frontend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="236" y="96.0339">for Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111" x="358.5" y="84.9659">Resource Owner</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="394.5" y="104.0339">(User)</text><ellipse cx="417" cy="18.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M417,26.5 L417,53.5 M404,34.5 L430,34.5 M417,53.5 L404,68.5 M417,53.5 L430,68.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="186" x="548" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="172" x="555" y="76.9659">User Agent / Frontend for</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="572" y="96.0339">Authorization Server</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="766.5" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="773.5" y="76.9659">Authorization Server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="810.5" y="96.0339">https://as</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="1232" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="1239" y="76.9659">Resource Server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="1262.5" y="96.0339">https://rs</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="75.5" y="2566.6013"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="106" y="2588.5673">Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="82.5" y="2607.6352">https://client</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="185.5" y="2566.6013"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="192.5" y="2588.5673">User Agent / Frontend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="236" y="2607.6352">for Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111" x="358.5" y="2641.5673">Resource Owner</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="394.5" y="2660.6352">(User)</text><ellipse cx="417" cy="2575.1013" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M417,2583.1013 L417,2610.1013 M404,2591.1013 L430,2591.1013 M417,2610.1013 L404,2625.1013 M417,2610.1013 L430,2625.1013 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="186" x="548" y="2566.6013"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="172" x="555" y="2588.5673">User Agent / Frontend for</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="572" y="2607.6352">Authorization Server</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="766.5" y="2566.6013"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="773.5" y="2588.5673">Authorization Server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="810.5" y="2607.6352">https://as</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="1232" y="2566.6013"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="1239" y="2588.5673">Resource Server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="1262.5" y="2607.6352">https://rs</text><path d="M688,121.1358 L688,166.1358 L997,166.1358 L997,131.1358 L987,121.1358 L688,121.1358 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M987,121.1358 L987,131.1358 L997,131.1358 L987,121.1358 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="694" y="140.0328">Relevant AS Metadata:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="694" y="157.7389">"dpop_signing_alg_values_supported": ["ES256"]</text><path d="M10,121.1358 L10,166.1358 L241,166.1358 L241,131.1358 L231,121.1358 L10,121.1358 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M231,121.1358 L231,131.1358 L241,131.1358 L231,121.1358 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="16" y="140.0328">Relevant Client Metadata:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="16" y="157.7389">"dpop_bound_access_tokens": true</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1443" x="5" y="193.4009"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="193.4009" y2="193.4009"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="196.4009" y2="196.4009"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="345" x="554" y="181.5479"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="328" x="560" y="199.4449">Authorization Code Binding to DPoP Key (optional)</text><path d="M90.5,221.2539 L153.5,221.2539 L153.5,230.9599 L143.5,240.9599 L90.5,240.9599 L90.5,221.2539 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="633.9263" style="stroke:#000000;stroke-width:1.5;" width="884.5" x="90.5" y="221.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="105.5" y="236.1509">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="235" x="168.5" y="235.0128">[with front-channel authorization request]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="975" y1="378.49" y2="378.49"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="188" x="95.5" y="392.2489">[with Push Authorization Request]</text><polygon fill="#181818" points="255,306.0779,265,310.0779,255,314.0779,259,310.0779" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="261" y1="310.0779" y2="310.0779"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="132.5" y="304.2689">(HTTPS 302)</text><polygon fill="#181818" points="629,306.0779,639,310.0779,629,314.0779,633,310.0779" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="267" x2="635" y1="310.0779" y2="310.0779"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="274" y="268.8569">Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="274" y="286.5629">Redirection to GET https://as/auth?…</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="280" y="304.2689">&amp;dpop_jkt=… (SHA-256 JWK Thumbprint of the public key)</text><polygon fill="#181818" points="830.5,306.0779,840.5,310.0779,830.5,314.0779,834.5,310.0779" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="641" x2="836.5" y1="310.0779" y2="310.0779"/><polygon fill="#181818" points="652,355.49,642,359.49,652,363.49,648,359.49" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="646" x2="841.5" y1="359.49" y2="359.49"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="658" y="353.681">(HTTPS 302)</text><polygon fill="#181818" points="278,355.49,268,359.49,278,363.49,274,359.49" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="272" x2="640" y1="359.49" y2="359.49"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="157" x="284" y="335.975">Authorization Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258" x="284" y="353.681">Redirection to GET https://client/callback?…</text><polygon fill="#181818" points="136.5,355.49,126.5,359.49,136.5,363.49,132.5,359.49" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="130.5" x2="266" y1="359.49" y2="359.49"/><path d="M109.5,404.4719 L172.5,404.4719 L172.5,414.1779 L162.5,424.1779 L109.5,424.1779 L109.5,404.4719 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="288.4722" style="stroke:#000000;stroke-width:1.5;" width="840.5" x="109.5" y="404.4719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="124.5" y="419.3689">alt</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="109.5" x2="950" y1="547.708" y2="547.708"/><polygon fill="#181818" points="830.5,524.708,840.5,528.708,830.5,532.708,834.5,528.708" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="836.5" y1="528.708" y2="528.708"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="200" x="132.5" y="452.0749">Pushed Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="132.5" y="469.7809">HTTPS POST https://as/par, urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="337" x="132.5" y="487.4869">(client authentication, cf. token_endpoint_auth_method)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="132.5" y="505.1929">…</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="132.5" y="522.899">&amp;dpop_jtk=… (SHA-256 JWK Thumbprint of the public key)</text><polygon fill="#181818" points="830.5,645.2381,840.5,649.2381,830.5,653.2381,834.5,649.2381" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="836.5" y1="649.2381" y2="649.2381"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="200" x="132.5" y="572.605">Pushed Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="132.5" y="590.311">HTTPS POST https://as/par, urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="337" x="132.5" y="608.017">(client authentication, cf. token_endpoint_auth_method)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="132.5" y="625.723">DPoP: eyJ…, (a proof of posession "dpop+jwt" token, see below)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="132.5" y="643.429">…</text><polygon fill="#FEFFDD" points="766,662.2381,919,662.2381,929,674.2381,919,687.2381,766,687.2381,756,674.2381,766,662.2381" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="768" y="680.1351">Validate dpop+jwt token.</text><polygon fill="#181818" points="136.5,744.3561,126.5,748.3561,136.5,752.3561,132.5,748.3561" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="130.5" x2="841.5" y1="748.3561" y2="748.3561"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="208" x="142.5" y="724.8411">Pushed Authorization Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="142.5" y="742.5471">HTTPS 200, JSON</text><polygon fill="#181818" points="255,793.7681,265,797.7681,255,801.7681,259,797.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="261" y1="797.7681" y2="797.7681"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="132.5" y="791.9591">(HTTPS 302)</text><polygon fill="#181818" points="629,793.7681,639,797.7681,629,801.7681,633,797.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="267" x2="635" y1="797.7681" y2="797.7681"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149" x="274" y="774.2531">Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="274" y="791.9591">Redirection to GET https://as/auth?request_uri=…</text><polygon fill="#181818" points="830.5,793.7681,840.5,797.7681,830.5,801.7681,834.5,797.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="641" x2="836.5" y1="797.7681" y2="797.7681"/><polygon fill="#181818" points="652,843.1802,642,847.1802,652,851.1802,648,847.1802" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="646" x2="841.5" y1="847.1802" y2="847.1802"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="658" y="841.3712">(HTTPS 302)</text><polygon fill="#181818" points="278,843.1802,268,847.1802,278,851.1802,274,847.1802" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="272" x2="640" y1="847.1802" y2="847.1802"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="157" x="284" y="823.6651">Authorization Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258" x="284" y="841.3712">Redirection to GET https://client/callback?…</text><polygon fill="#181818" points="136.5,843.1802,126.5,847.1802,136.5,851.1802,132.5,847.1802" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="130.5" x2="266" y1="847.1802" y2="847.1802"/><polygon fill="#FEFFDD" points="727,874.1802,958,874.1802,968,895.1802,958,917.1802,727,917.1802,717,895.1802,727,874.1802" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="729" y="892.0772">Returned authorization code is bound</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="729" y="909.7832">to the requested public key</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1443" x="5" y="944.4452"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="944.4452" y2="944.4452"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="947.4452" y2="947.4452"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="198" x="627.5" y="932.5922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="181" x="633.5" y="950.4892">DPoP Access Token Request</text><polygon fill="#181818" points="830.5,1147.3584,840.5,1151.3584,830.5,1155.3584,834.5,1151.3584" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="836.5" y1="1151.3584" y2="1151.3584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="181" x="132.5" y="986.1952">DPoP Access Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356" x="132.5" y="1003.9012">HTTPS POST https://as/token (token_endpoint), urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="693" x="132.5" y="1021.6073">Authorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="298" x="132.5" y="1039.3133">DPoP: eyJ…, (a proof of posession "dpop+jwt" JWT)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="132.5" y="1057.0193"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="132.5" y="1074.7253">client_id=CID-XXXX</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="132.5" y="1092.4313">&amp;grant_type=authorization_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="132.5" y="1110.1373">&amp;code=AC-XXXX</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="132.5" y="1127.8434">&amp;redirect_uri=https%3A%2F%2Fclient%2Fcallback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="442" x="132.5" y="1145.5494">&amp;code_verifier=CV-XXXXV (if and only if code_challenge was used i.e. PKCE)</text><path d="M847.5,973.2982 L847.5,1177.2982 L1297.5,1177.2982 L1297.5,983.2982 L1287.5,973.2982 L847.5,973.2982 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1287.5,973.2982 L1287.5,983.2982 L1297.5,983.2982 L1287.5,973.2982 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="429" x="853.5" y="992.1952">The DPoP header contains a proof of possession of the client private key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="853.5" y="1009.9012">in the form of a ("dpop+jwt") JWT.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="58" x="853.5" y="1027.6073">Headers:</text><ellipse cx="859" cy="1041.6223" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="865.5" y="1045.3133">"typ": "dpop+jwt" (token type)</text><ellipse cx="859" cy="1059.3283" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="865.5" y="1063.0193">"alg": "ES256" (signature algorithm)</text><ellipse cx="859" cy="1077.0343" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="865.5" y="1080.7253">"jwk": {…} (public key)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="47" x="853.5" y="1098.4313">Claims:</text><ellipse cx="859" cy="1112.4464" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="865.5" y="1116.1373">"jti": "…" (unique ID)</text><ellipse cx="859" cy="1130.1524" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="865.5" y="1133.8434">"iat": … (timestamp)</text><ellipse cx="859" cy="1147.8584" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="865.5" y="1151.5494">"htm": "POST" (HTTP method)</text><ellipse cx="859" cy="1165.5644" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="865.5" y="1169.2554">"htu": "https://as/token" (target URI without query and fragment)</text><polygon fill="#FEFFDD" points="766,1188.0644,919,1188.0644,929,1200.0644,919,1213.0644,766,1213.0644,756,1200.0644,766,1188.0644" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="768" y="1205.9614">Validate dpop+jwt token.</text><path d="M109.5,1222.7704 L176.5,1222.7704 L176.5,1232.4764 L166.5,1242.4764 L109.5,1242.4764 L109.5,1222.7704 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="272.4722" style="stroke:#000000;stroke-width:1.5;" width="861" x="109.5" y="1222.7704"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="124.5" y="1237.6674">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="386" x="191.5" y="1236.5293">[AS uses nonces and no expected nonce was supplied in the dpop+jwt]</text><path d="M735.5,1257.4764 L735.5,1302.4764 L949.5,1302.4764 L949.5,1267.4764 L939.5,1257.4764 L735.5,1257.4764 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M939.5,1257.4764 L939.5,1267.4764 L949.5,1267.4764 L939.5,1257.4764 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="741.5" y="1276.3734">AS is expected to keep a window</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="741.5" y="1294.0795">of recent (acceptable) nonces.</text><polygon fill="#181818" points="136.5,1380.7125,126.5,1384.7125,136.5,1388.7125,132.5,1384.7125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="130.5" x2="841.5" y1="1384.7125" y2="1384.7125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="152" x="142.5" y="1325.7855">Access Token Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="142.5" y="1343.4915">HTTPS 400, JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="142.5" y="1361.1975">DPoP-Nonce: DN-XXXX</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="142.5" y="1378.9035">"error": "use_dpop_nonce"</text><polygon fill="#181818" points="830.5,1483.2426,840.5,1487.2426,830.5,1491.2426,834.5,1487.2426" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="836.5" y1="1487.2426" y2="1487.2426"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="181" x="132.5" y="1410.6095">DPoP Access Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356" x="132.5" y="1428.3156">HTTPS POST https://as/token (token_endpoint), urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="693" x="132.5" y="1446.0216">Authorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="576" x="132.5" y="1463.7276">DPOP: eyJ…, (a Proof of Posession "dpop+jwt" JWT with additional claim "nonce: "DN-XXXX" claim)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="132.5" y="1481.4336">client_id=CID-XXXX&amp;…</text><path d="M631,1513.2426 L698,1513.2426 L698,1522.9486 L688,1532.9486 L631,1532.9486 L631,1513.2426 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="83.118" style="stroke:#000000;stroke-width:1.5;" width="423" x="631" y="1513.2426"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="646" y="1528.1396">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="273" x="713" y="1527.0015">[Authorization Code Binding to DPoP Key as used]</text><polygon fill="#FEFFDD" points="662,1547.9486,1023,1547.9486,1033,1568.9486,1023,1590.9486,662,1590.9486,652,1568.9486,662,1547.9486" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="664" y="1565.8456">Check the public key is the proof of possession</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357" x="664" y="1583.5517">matches with the one specified in the authorization request.</text><polygon fill="#181818" points="136.5,1807.1268,126.5,1811.1268,136.5,1815.1268,132.5,1811.1268" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="130.5" x2="841.5" y1="1811.1268" y2="1811.1268"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="152" x="142.5" y="1628.2577">Access Token Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="142.5" y="1645.9637">HTTPS 200, JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="380" x="142.5" y="1663.6697">DPoP-Nonce: DN-YYYY (OPTIONAL, used to supply a new nonce)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="142.5" y="1681.3757"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="142.5" y="1699.0817">"access_token":"AT-XXXX", (opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="142.5" y="1716.7878">"token_type":"DPoP",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="142.5" y="1734.4938">"expires_in":3600,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="142.5" y="1752.1998">"refresh_token":"RT-XXXX", (OPTIONAL, opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="142.5" y="1769.9058">"scope":"scope1 scope2",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="467" x="142.5" y="1787.6118">"authorization_details": [{"type": "…", …}, …] (extension, see draft-ietf-oauth-rar)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="142.5" y="1805.3178"> </text><path d="M847.5,1615.3607 L847.5,1748.3607 L1239.5,1748.3607 L1239.5,1625.3607 L1229.5,1615.3607 L847.5,1615.3607 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1229.5,1615.3607 L1229.5,1625.3607 L1239.5,1625.3607 L1229.5,1615.3607 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="274" x="853.5" y="1634.2577">access_token is bound to the client public key.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="853.5" y="1651.9637">When it is a JWT, the "cnf" claim can be used:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="865.5" y="1669.6697">"cnf": {"jkt": "…"} (SHA-256 JWK Thumbprint of the public key)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="853.5" y="1687.3757"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="246" x="853.5" y="1705.0817">refresh_token (if ANY) SHOULD be bound</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="853.5" y="1722.7878">to the client key pair as well</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="853.5" y="1740.4938">when the client is a public client.</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1443" x="5" y="1840.9799"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="1840.9799" y2="1840.9799"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="1843.9799" y2="1843.9799"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="192" x="630.5" y="1829.1268"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="175" x="636.5" y="1847.0239">Protected Resource Access</text><polygon fill="#181818" points="1281.5,1955.3629,1291.5,1959.3629,1281.5,1963.3629,1285.5,1959.3629" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="1287.5" y1="1959.3629" y2="1959.3629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="132.5" y="1882.7299">Protected Resource Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="321" x="132.5" y="1900.4359">HTTPS GET/POST/… https://rs/api/protected_resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="132.5" y="1918.1419">Authorization: DPoP AT-XXXX (access token)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="132.5" y="1935.8479">DPoP: eyJ…, a "dpop+jwt" token with additional claim,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="138.5" y="1953.5539">"ath": "…", SHA-256 hash of the access_token</text><polygon fill="#FEFFDD" points="1226.5,1972.3629,1360.5,1972.3629,1370.5,1984.3629,1360.5,1997.3629,1226.5,1997.3629,1216.5,1984.3629,1226.5,1972.3629" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="1228.5" y="1990.26">Validate access_token</text><polygon fill="#FEFFDD" points="1218.5,2008.069,1368.5,2008.069,1378.5,2020.069,1368.5,2033.069,1218.5,2033.069,1208.5,2020.069,1218.5,2008.069" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="1220.5" y="2025.966">Validate dpop+jwt token</text><polygon fill="#FEFFDD" points="1154,2043.775,1433,2043.775,1443,2064.775,1433,2086.775,1154,2086.775,1144,2064.775,1154,2043.775" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="1156" y="2061.672">Check the public key in the dpop+jwt matches</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="1156" y="2079.378">with the one associated with the access_token</text><path d="M109.5,2096.187 L176.5,2096.187 L176.5,2105.893 L166.5,2115.893 L109.5,2115.893 L109.5,2096.187 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="234.7662" style="stroke:#000000;stroke-width:1.5;" width="1200" x="109.5" y="2096.187"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="124.5" y="2111.084">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="370" x="191.5" y="2109.9459">[RS uses nonces and no expected was not supplied in the dpop+jwt]</text><polygon fill="#181818" points="136.5,2198.7171,126.5,2202.7171,136.5,2206.7171,132.5,2202.7171" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="130.5" x2="1292.5" y1="2202.7171" y2="2202.7171"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="194" x="142.5" y="2143.79">Protected Resource Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="142.5" y="2161.4961">HTTPS 401N</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="142.5" y="2179.2021">WWW-Authenticate: DPoP error="use_dpop_nonce, …</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="142.5" y="2196.9081">DPoP-Nonce: DN-XXXX</text><polygon fill="#181818" points="1281.5,2318.9532,1291.5,2322.9532,1281.5,2326.9532,1285.5,2322.9532" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="1287.5" y1="2322.9532" y2="2322.9532"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="132.5" y="2228.6141">Protected Resource Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="321" x="132.5" y="2246.3201">HTTPS GET/POST/… https://rs/api/protected_resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="132.5" y="2264.0261">Authorization: DPoP AT-XXXX (access token)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="132.5" y="2281.7322">DPoP: eyJ…, a "dpop+jwt" with the same claims as above and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="138.5" y="2299.4382">"ath": "…", SHA-256 hash of the access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="138.5" y="2317.1442">"nonce": "DN-XXXX",</text><polygon fill="#181818" points="136.5,2364.6592,126.5,2368.6592,136.5,2372.6592,132.5,2368.6592" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="130.5" x2="1292.5" y1="2368.6592" y2="2368.6592"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="194" x="142.5" y="2362.8502">Protected Resource Response</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1443" x="5" y="2398.5122"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="2398.5122" y2="2398.5122"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1448" y1="2401.5122" y2="2401.5122"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="151" x="651" y="2386.6592"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="134" x="657" y="2404.5562">Token Introspection</text><polygon fill="#181818" points="853.5,2459.7773,843.5,2463.7773,853.5,2467.7773,849.5,2463.7773" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="847.5" x2="1292.5" y1="2463.7773" y2="2463.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="859.5" y="2440.2622">Introspection Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="427" x="859.5" y="2457.9683">HTTPS POST https://as/introspect (introspection_endpoint), urlencoded</text><polygon fill="#181818" points="1281.5,2544.6013,1291.5,2548.6013,1281.5,2552.6013,1285.5,2548.6013" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="842.5" x2="1287.5" y1="2548.6013" y2="2548.6013"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="155" x="849.5" y="2489.6743">Introspection Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="849.5" y="2507.3803">HTTPS 200, JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="849.5" y="2525.0863">…</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="362" x="849.5" y="2542.7923">"cnf": {"jkt": "…"}, (SHA-256 JWK Thumbprint of the public key)</text><!--MD5=[0f4ffc00b2310dd27d66e770f249d972]
@startuml

!pragma teoz true

participant "Client\nhttps://client" as client
box
    participant "User Agent / Frontend\nfor Client" as uac
    actor "Resource Owner\n(User)" as user
    participant "User Agent / Frontend for\nAuthorization Server" as uaas
end box
participant "Authorization Server\nhttps://as" as as
participant "Resource Server\nhttps://rs" as rs

note over as: Relevant AS Metadata:\n"dpop_signing_alg_values_supported": ["ES256"]

&note over client: Relevant Client Metadata:\n"dpop_bound_access_tokens": true

== Authorization Code Binding to DPoP Key (optional) ==

alt with front-channel authorization request

client -> uac : (HTTPS 302)
& uac -> uaas: **Authorization Request**\nRedirection to GET https://as/auth?…\n  &dpop_jkt=… (SHA-256 JWK Thumbprint of the public key)
& uaas -> as

as -> uaas : (HTTPS 302)

&uaas -> uac: **Authorization Response**\nRedirection to GET https://client/callback?…

& uac -> client

else with Push Authorization Request

alt

client -> as: **Pushed Authorization Request**\nHTTPS POST https://as/par, urlencoded\n(client authentication, cf. token_endpoint_auth_method)\n…\n&dpop_jtk=… (SHA-256 JWK Thumbprint of the public key)

else

client -> as: **Pushed Authorization Request**\nHTTPS POST https://as/par, urlencoded\n(client authentication, cf. token_endpoint_auth_method)\nDPoP: eyJ…, (a proof of posession "dpop+jwt" token, see below)\n…

hnote over as: Validate dpop+jwt token.

end

as -> client: **Pushed Authorization Response**\nHTTPS 200, JSON

client -> uac : (HTTPS 302)
& uac -> uaas: **Authorization Request**\nRedirection to GET https://as/auth?request_uri=…

& uaas -> as

as -> uaas : (HTTPS 302)
& uaas -> uac: **Authorization Response**\nRedirection to GET https://client/callback?…

& uac -> client

end

hnote over as: Returned authorization code is bound\nto the requested public key

== DPoP Access Token Request ==

client -> as : **DPoP Access Token Request**\nHTTPS POST https://as/token (token_endpoint), urlencoded\nAuthorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)\nDPoP: eyJ…, (a proof of posession "dpop+jwt" JWT)\n\nclient_id=CID-XXXX\n&grant_type=authorization_code\n&code=AC-XXXX\n&redirect_uri=https%3A%2F%2Fclient%2Fcallback\n&code_verifier=CV-XXXXV (if and only if code_challenge was used i.e. PKCE)

note right: The DPoP header contains a proof of possession of the client private key\nin the form of a ("dpop+jwt") JWT.\n**Headers:**\n* "typ": "dpop+jwt" (token type)\n* "alg": "ES256" (signature algorithm)\n* "jwk": {…} (public key)\n**Claims:**\n* "jti": "…" (unique ID)\n* "iat": … (timestamp)\n* "htm": "POST" (HTTP method)\n* "htu": "https://as/token" (target URI without query and fragment)

hnote over as: Validate dpop+jwt token.

opt AS uses nonces and no expected nonce was supplied in the dpop+jwt

note over as: AS is expected to keep a window\nof recent (acceptable) nonces.

client <- - as : **Access Token Response**\nHTTPS 400, JSON\nDPoP-Nonce: DN-XXXX\n"error": "use_dpop_nonce"

client -> as : **DPoP Access Token Request**\nHTTPS POST https://as/token (token_endpoint), urlencoded\nAuthorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)\nDPOP: eyJ…, (a Proof of Posession "dpop+jwt" JWT with additional claim "nonce: "DN-XXXX" claim)\nclient_id=CID-XXXX&…

end

opt Authorization Code Binding to DPoP Key as used
hnote over as: Check the public key is the proof of possession\nmatches with the one specified in the authorization request.
end

client <- - as : **Access Token Response**\nHTTPS 200, JSON\nDPoP-Nonce: DN-YYYY (OPTIONAL, used to supply a new nonce)\n\n"access_token":"AT-XXXX", (opaque)\n"token_type":"DPoP",\n"expires_in":3600,\n"refresh_token":"RT-XXXX", (OPTIONAL, opaque)\n"scope":"scope1 scope2",\n"authorization_details": [{"type": "…", …}, …] (extension, see draft-ietf-oauth-rar)\n
note right: access_token is bound to the client public key.\nWhen it is a JWT, the "cnf" claim can be used:\n    "cnf": {"jkt": "…"} (SHA-256 JWK Thumbprint of the public key)\n\nrefresh_token (if ANY) SHOULD be bound\nto the client key pair as well\nwhen the client is a public client.

== Protected Resource Access ==

client -> rs: **Protected Resource Request**\nHTTPS GET/POST/… https://rs/api/protected_resource\nAuthorization: DPoP AT-XXXX (access token)\nDPoP: eyJ…, a "dpop+jwt" token with additional claim,\n  "ath": "…", SHA-256 hash of the access_token

hnote over rs: Validate access_token
hnote over rs: Validate dpop+jwt token
hnote over rs: Check the public key in the dpop+jwt matches\nwith the one associated with the access_token

opt RS uses nonces and no expected was not supplied in the dpop+jwt

client <- - rs : **Protected Resource Response**\nHTTPS 401N\nWWW-Authenticate: DPoP error="use_dpop_nonce, …\nDPoP-Nonce: DN-XXXX

client -> rs: **Protected Resource Request**\nHTTPS GET/POST/… https://rs/api/protected_resource\nAuthorization: DPoP AT-XXXX (access token)\nDPoP: eyJ…, a "dpop+jwt" with the same claims as above and\n  "ath": "…", SHA-256 hash of the access_token\n  "nonce": "DN-XXXX",

end

rs -> client: **Protected Resource Response**

== Token Introspection ==

rs -> as : **Introspection Request**\nHTTPS POST https://as/introspect (introspection_endpoint), urlencoded

as - -> rs: **Introspection Response**\nHTTPS 200, JSON\n…\n"cnf": {"jkt": "…"}, (SHA-256 JWK Thumbprint of the public key)

@enduml

PlantUML version 1.2022.13(Sat Nov 19 14:22:17 CET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>