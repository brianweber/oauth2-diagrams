<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2204px" preserveAspectRatio="none" style="width:1574px;height:2204px;background:#FFFFFF;" version="1.1" viewBox="0 0 1574 2204" width="1574px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="2192.1873" style="stroke:#181818;stroke-width:0.5;" width="877.5" x="363.5" y="6"/><rect fill="none" height="100.8241" style="stroke:#000000;stroke-width:1.5;" width="302" x="8" y="176.8419"/><rect fill="none" height="358.6404" style="stroke:#000000;stroke-width:1.5;" width="1391" x="89" y="624.6003"/><rect fill="none" height="197.8742" style="stroke:#000000;stroke-width:1.5;" width="581" x="16.5" y="1125.7707"/><rect fill="none" height="65.412" style="stroke:#000000;stroke-width:1.5;" width="537" x="35.5" y="1244.2329"/><rect fill="none" height="186.5301" style="stroke:#000000;stroke-width:1.5;" width="388" x="1179" y="1593.7051"/><rect fill="none" height="67.412" style="stroke:#000000;stroke-width:1.5;" width="325" x="1198" y="1698.8232"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="159" x2="159" y1="108.1358" y2="2094.0515"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="449" x2="449" y1="108.1358" y2="2094.0515"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="626.5" x2="626.5" y1="108.1358" y2="2094.0515"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1144" x2="1144" y1="108.1358" y2="2094.0515"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1360.5" x2="1360.5" y1="108.1358" y2="2094.0515"/><rect fill="#E2E2F0" height="71.2038" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="108" x="105" y="35.9321"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="115" y="57.898">Relying Party</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="94" x="112" y="76.9659">(OAuth Client)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="127" y="96.0339">https://rp</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="367.5" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="374.5" y="76.9659">User Agent / Frontend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111" x="393.5" y="96.0339">for Relying Party</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="608" y="84.9659">User</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="540.5" y="104.0339">(OAuth Resource Owner)</text><ellipse cx="626.5" cy="18.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M626.5,26.5 L626.5,53.5 M613.5,34.5 L639.5,34.5 M626.5,53.5 L613.5,68.5 M626.5,53.5 L639.5,68.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="186" x="1051" y="55"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="172" x="1058" y="76.9659">User Agent / Frontend for</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="1088" y="96.0339">OpenID Provider</text><rect fill="#E2E2F0" height="71.2038" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="207" x="1257" y="35.9321"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="1304.5" y="57.898">OpenID Provider</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="193" x="1264" y="76.9659">(OAuth Authorization Server)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1327.5" y="96.0339">https://op</text><rect fill="#E2E2F0" height="71.2038" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="108" x="105" y="2094.0515"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="115" y="2116.0174">Relying Party</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="94" x="112" y="2135.0854">(OAuth Client)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="127" y="2154.1533">https://rp</text><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="367.5" y="2094.0515"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="374.5" y="2116.0174">User Agent / Frontend</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111" x="393.5" y="2135.0854">for Relying Party</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="608" y="2169.0174">User</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="540.5" y="2188.0854">(OAuth Resource Owner)</text><ellipse cx="626.5" cy="2102.5515" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M626.5,2110.5515 L626.5,2137.5515 M613.5,2118.5515 L639.5,2118.5515 M626.5,2137.5515 L613.5,2152.5515 M626.5,2137.5515 L639.5,2152.5515 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="52.1358" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="186" x="1051" y="2094.0515"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="172" x="1058" y="2116.0174">User Agent / Frontend for</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="1088" y="2135.0854">OpenID Provider</text><rect fill="#E2E2F0" height="71.2038" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="207" x="1257" y="2094.0515"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="1304.5" y="2116.0174">OpenID Provider</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="193" x="1264" y="2135.0854">(OAuth Authorization Server)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1327.5" y="2154.1533">https://op</text><polygon fill="#181818" points="460,135.8419,450,139.8419,460,143.8419,456,139.8419" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="454" x2="625.5" y1="139.8419" y2="139.8419"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="466" y="134.0328">Request to login</text><polygon fill="#181818" points="170,135.8419,160,139.8419,170,143.8419,166,139.8419" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="164" x2="448" y1="139.8419" y2="139.8419"/><path d="M8,176.8419 L75,176.8419 L75,186.5479 L65,196.5479 L8,196.5479 L8,176.8419 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="100.8241" style="stroke:#000000;stroke-width:1.5;" width="302" x="8" y="176.8419"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="23" y="191.7389">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="64" x="90" y="190.6008">[PKCE used]</text><polygon fill="#FEFFDD" points="39,211.5479,279,211.5479,289,241.5479,279,272.5479,39,272.5479,29,241.5479,39,211.5479" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="41" y="229.4449">Generate random code_verifier</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="41" y="247.1509">and derive code_challenge=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="47" y="264.8569">code_challenge_method(code_verifier)</text><polygon fill="#181818" points="437,523.8441,447,527.8441,437,531.8441,441,527.8441" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="159" x2="443" y1="527.8441" y2="527.8441"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="166" y="522.0351">(HTTPS 302)</text><polygon fill="#181818" points="1132,523.8441,1142,527.8441,1132,531.8441,1136,527.8441" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="449" x2="1138" y1="527.8441" y2="527.8441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="159" x="456" y="309.5629">Authentication Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="184" x="618" y="309.5629">(OAuth Authorization Request)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357" x="456" y="327.2689">Redirection to GET https://rp/auth (authorization_endpoint)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="473" x="462" y="344.975">?response_type= code id_token / code token / code id_token token (REQUIRED)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="462" y="362.681">&amp;client_id=CID-XXXX (REQUIRED, opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="530" x="462" y="380.387">&amp;redirect_uri=https%3A%2F%2Fclient%2Ecallback (always REQUIRED in OpenID Connect)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="462" y="398.093">&amp;scope=openid+profile+email+phone (OPTIONAL)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="462" y="415.799">&amp;state=AS-XXXX (RECOMMENDED, opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="365" x="462" y="433.505">&amp;nonce=AN-XXXX (REQUIRED, protect against replay attacks)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="6" x="456" y="451.2111">  </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="462" y="468.9171">&amp;code_challenge_method=S256 (if PKCE used)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241" x="462" y="486.6231">&amp;code_challenge=CCCCCC (if PKCE used)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="6" x="456" y="504.3291">  </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="462" y="522.0351">…</text><polygon fill="#181818" points="1348.5,523.8441,1358.5,527.8441,1348.5,531.8441,1352.5,527.8441" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1144" x2="1354.5" y1="527.8441" y2="527.8441"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="1151" y="522.0351">HTTPS GET https://rp/…</text><polygon fill="#FEFFDD" points="1244.5,540.8441,1476.5,540.8441,1486.5,552.8441,1476.5,565.8441,1244.5,565.8441,1234.5,552.8441,1244.5,540.8441" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="1246.5" y="558.7411">Check redirect_uri allowed for client_id</text><rect fill="none" height="44.0501" style="stroke:#000000;stroke-width:1.5;" width="919.5" x="542.5" y="571.5501"/><path d="M542.5,571.5501 L606.5,571.5501 L606.5,580.5501 L596.5,590.5501 L542.5,590.5501 L542.5,571.5501 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="555.5" y="587.4472">ref</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="181" x="911.75" y="607.3782">User authentication and consent</text><path d="M89,624.6003 L152,624.6003 L152,634.3063 L142,644.3063 L89,644.3063 L89,624.6003 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="358.6404" style="stroke:#000000;stroke-width:1.5;" width="1391" x="89" y="624.6003"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="104" y="639.4973">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="133" x="167" y="638.3592">[response_mode=query]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="89" x2="1480" y1="927.1905" y2="927.1905"/><polygon fill="#181818" points="1155,904.1905,1145,908.1905,1155,912.1905,1151,908.1905" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1149" x2="1359.5" y1="908.1905" y2="908.1905"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="1161" y="902.3815">(HTTPS 302)</text><polygon fill="#181818" points="460,904.1905,450,908.1905,460,912.1905,456,908.1905" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="454" x2="1143" y1="908.1905" y2="908.1905"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="167" x="466" y="672.2033">Authentication Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="636" y="672.2033">(OAuth Authorization Response)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="466" y="689.9093">Redirection to GET https://rp/callback (redirect_uri)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="472" y="707.6153">?code=AC-XXXX (REQUIRED)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="308" x="472" y="725.3214">&amp;access_token=AT-XXXX (if token in response_type)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="472" y="743.0274">&amp;token_type=bearer (if token in response_type)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370" x="472" y="760.7334">&amp;id_token=eyJ… JWT with claims (if id_token in response_type)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="10" x="478" y="778.4394">…</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="478" y="796.1454">"nonce": "AN-XXXX", (REQUIRED in this flow)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="542" x="478" y="813.8514">"at_hash": "…" (included when token in response_type, half of the hash of the access_token)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="659" x="478" y="831.5575">"c_hash": "…" (REQUIRED when both code and id_token included in response_type, half of the hash of the code)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="472" y="849.2635">&amp;scope=scope1 scope2 (OPTIONAL)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="472" y="866.9695">&amp;state=AS-XXXX (if given)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="472" y="884.6755">&amp;expires_in=3600 (OPTIONAL)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="472" y="902.3815">&amp;iss=https://op (extension)</text><polygon fill="#181818" points="170,904.1905,160,908.1905,170,912.1905,166,908.1905" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="164" x2="448" y1="908.1905" y2="908.1905"/><rect fill="none" height="44.0501" style="stroke:#000000;stroke-width:1.5;" width="1355" x="107" y="934.1905"/><path d="M107,934.1905 L171,934.1905 L171,943.1905 L161,953.1905 L107,953.1905 L107,934.1905 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="120" y="950.0875">ref</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="120" x="724.5" y="970.0186">other reponse modes</text><polygon fill="#FEFFDD" points="38,1002.2407,280,1002.2407,290,1032.2407,280,1063.2407,38,1063.2407,28,1032.2407,38,1002.2407" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="40" y="1020.1377">Check validity of state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238" x="40" y="1037.8437">and its association with the user session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="40" y="1055.5497">(protection against CSRF)</text><polygon fill="#FEFFDD" points="58.5,1073.3587,259.5,1073.3587,269.5,1094.3587,259.5,1116.3587,58.5,1116.3587,48.5,1094.3587,58.5,1073.3587" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="60.5" y="1091.2557">Check "iss" field (if given),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="60.5" y="1108.9617">protection against mixup attacks</text><path d="M16.5,1125.7707 L83.5,1125.7707 L83.5,1135.4768 L73.5,1145.4768 L16.5,1145.4768 L16.5,1125.7707 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="197.8742" style="stroke:#000000;stroke-width:1.5;" width="581" x="16.5" y="1125.7707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="31.5" y="1140.6678">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="98.5" y="1139.5297">[id_token in reponse_type]</text><rect fill="none" height="44.0501" style="stroke:#000000;stroke-width:1.5;" width="421.5" x="107" y="1155.4768"/><path d="M107,1155.4768 L171,1155.4768 L171,1164.4768 L161,1174.4768 L107,1174.4768 L107,1155.4768 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="120" y="1171.3738">ref</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="266" x="184.75" y="1191.3048">Process id_token (decrypt if necessary, validate)</text><polygon fill="#FEFFDD" points="94.5,1209.5269,513.5,1209.5269,523.5,1221.5269,513.5,1234.5269,94.5,1234.5269,84.5,1221.5269,94.5,1209.5269" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415" x="96.5" y="1227.4239">Check code against c_hash (protect against code substitution attacks)</text><path d="M35.5,1244.2329 L102.5,1244.2329 L102.5,1253.9389 L92.5,1263.9389 L35.5,1263.9389 L35.5,1244.2329 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="65.412" style="stroke:#000000;stroke-width:1.5;" width="537" x="35.5" y="1244.2329"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="50.5" y="1259.1299">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="137" x="117.5" y="1257.9918">[token in response_type]</text><polygon fill="#FEFFDD" points="66.5,1278.9389,541.5,1278.9389,551.5,1290.9389,541.5,1303.9389,66.5,1303.9389,56.5,1290.9389,66.5,1278.9389" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="471" x="68.5" y="1296.8359">Check code against at_hash (protect against access_token substitution attacks)</text><polygon fill="#181818" points="1348.5,1488.5871,1358.5,1492.5871,1348.5,1496.5871,1352.5,1492.5871" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="159" x2="1354.5" y1="1492.5871" y2="1492.5871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="166" y="1380.542">Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="267" y="1380.542">(OAuth Access Token Request)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="166" y="1398.248">HTTPS POST https://op/token (token_endpoint), urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="693" x="166" y="1415.954">Authorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="166" y="1433.66">grant_type=authorization_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="172" y="1451.366">&amp;code=AC-XXXX</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="488" x="172" y="1469.072">&amp;redirect_uri=https%3A%2F%2Fclient%2Fcallback (REQUIRED, same as in request)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="172" y="1486.778">&amp;code_verifier=CV-XXXXV (if code_challenge was used i.e. PKCE)</text><polygon fill="#FEFFDD" points="1274,1505.5871,1447,1505.5871,1457,1526.5871,1447,1548.5871,1274,1548.5871,1264,1526.5871,1274,1505.5871" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1276" y="1523.4841">Check (client authentication,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="1276" y="1541.1901">redirect_uri, code, etc)</text><polygon fill="#FEFFDD" points="1270,1558.9991,1451,1558.9991,1461,1570.9991,1451,1583.9991,1270,1583.9991,1260,1570.9991,1270,1558.9991" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="1272" y="1576.8961">Check code issued to client_id</text><path d="M1179,1593.7051 L1246,1593.7051 L1246,1603.4111 L1236,1613.4111 L1179,1613.4111 L1179,1593.7051 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="186.5301" style="stroke:#000000;stroke-width:1.5;" width="388" x="1179" y="1593.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="1194" y="1608.6021">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="290" x="1261" y="1607.464">[code_challenge was sent in authentication request]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1179" x2="1567" y1="1687.8232" y2="1687.8232"/><polygon fill="#FEFFDD" points="1235.5,1628.4111,1485.5,1628.4111,1495.5,1649.4111,1485.5,1671.4111,1235.5,1671.4111,1225.5,1649.4111,1235.5,1628.4111" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="1237.5" y="1646.3081">Check code_verifier=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="246" x="1237.5" y="1664.0141">code_challenge_method(code_challenge)</text><path d="M1198,1698.8232 L1281,1698.8232 L1281,1708.5292 L1271,1718.5292 L1198,1718.5292 L1198,1698.8232 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="67.412" style="stroke:#000000;stroke-width:1.5;" width="325" x="1198" y="1698.8232"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="38" x="1213" y="1713.7202">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="153" x="1296" y="1712.5821">[code_verifier was supplied]</text><path d="M1219,1733.5292 L1219,1760.5292 L1502,1760.5292 L1502,1743.5292 L1492,1733.5292 L1219,1733.5292 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1492,1733.5292 L1492,1743.5292 L1502,1743.5292 L1492,1733.5292 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="1225" y="1752.4262">Protection against PKCE downgrade attacks</text><polygon fill="#FEFFDD" points="1285.5,1799.2352,1435.5,1799.2352,1445.5,1811.2352,1435.5,1824.2352,1285.5,1824.2352,1275.5,1811.2352,1285.5,1799.2352" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="1287.5" y="1817.1322">Revoke code (single use)</text><polygon fill="#181818" points="170,1991.2954,160,1995.2954,170,1999.2954,166,1995.2954" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="164" x2="1359.5" y1="1995.2954" y2="1995.2954"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="106" x="176" y="1847.8382">Token Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="285" y="1847.8382">(OAuth Access Token Response)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="176" y="1865.5442">HTTPS 200, JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="176" y="1883.2502">"access_token":"AT-XXXX", (opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="871" x="188" y="1900.9563">(may have different security characteristics than the access_token returned in the authentication request eg. give access to more user information)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="176" y="1918.6623">"token_type":"bearer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="176" y="1936.3683">"expires_in":3600</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="176" y="1954.0743">"refresh_token":"RT-XXXX", (OPTIONAL, opaque)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="176" y="1971.7803">"scope":"scope1 scope2",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="636" x="176" y="1989.4863">"id_token": JWT (may contain more information than the id_token returned in the authentication response)</text><rect fill="none" height="44.0501" style="stroke:#000000;stroke-width:1.5;" width="274" x="107" y="2003.2954"/><path d="M107,2003.2954 L171,2003.2954 L171,2012.2954 L161,2022.2954 L107,2022.2954 L107,2003.2954 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="120" y="2019.1924">ref</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="266" x="111" y="2039.1234">Process id_token (decrypt if necessary, validate)</text><polygon fill="#181818" points="437,2072.0515,447,2076.0515,437,2080.0515,441,2076.0515" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="159" x2="443" y1="2076.0515" y2="2076.0515"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="266" x="166" y="2070.2425">Restore application state (eg. target_link_uri)</text><polygon fill="#181818" points="614.5,2072.0515,624.5,2076.0515,614.5,2080.0515,618.5,2076.0515" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="449" x2="620.5" y1="2076.0515" y2="2076.0515"/><!--MD5=[d62c191e113f6e3055754abdfb53b777]
@startuml

!pragma teoz true

participant "Relying Party\n(OAuth Client)\nhttps://rp" as client
box
    participant "User Agent / Frontend\nfor Relying Party" as uac
    actor "User\n(OAuth Resource Owner)" as user
    participant "User Agent / Frontend for\nOpenID Provider" as uaas
end box
participant "OpenID Provider\n(OAuth Authorization Server)\nhttps://op" as as


user -> uac: Request to login
& uac -> client

|||

opt PKCE used

hnote over client: Generate random code_verifier\nand derive code_challenge=\n  code_challenge_method(code_verifier)

end

client -> uac : (HTTPS 302)
& uac -> uaas: **Authentication Request** (OAuth Authorization Request)\nRedirection to GET https://rp/auth (authorization_endpoint)\n  ?response_type= code id_token / code token / code id_token token (REQUIRED)\n  &client_id=CID-XXXX (REQUIRED, opaque)\n  &redirect_uri=https%3A%2F%2Fclient%2Ecallback (always REQUIRED in OpenID Connect)\n  &scope=openid+profile+email+phone (OPTIONAL)\n  &state=AS-XXXX (RECOMMENDED, opaque)\n  &nonce=AN-XXXX (REQUIRED, protect against replay attacks)\n  \n  &code_challenge_method=S256 (if PKCE used)\n  &code_challenge=CCCCCC (if PKCE used)\n  \n  …
& uaas -> as: HTTPS GET https://rp/…

hnote over as: Check redirect_uri allowed for client_id

ref over user, as: User authentication and consent

alt response_mode=query

as - -> uaas: (HTTPS 302)
& uaas - -> uac: **Authentication Response** (OAuth Authorization Response)\nRedirection to GET https://rp/callback (redirect_uri)\n  ?code=AC-XXXX (REQUIRED)\n  &access_token=AT-XXXX (if token in response_type)\n  &token_type=bearer (if token in response_type)\n  &id_token=eyJ… JWT with claims (if id_token in response_type)\n    … \n    "nonce": "AN-XXXX", (REQUIRED in this flow)\n    "at_hash": "…" (included when token in response_type, half of the hash of the access_token)\n    "c_hash": "…" (REQUIRED when both code and id_token included in response_type, half of the hash of the code)\n  &scope=scope1 scope2 (OPTIONAL)\n  &state=AS-XXXX (if given)\n  &expires_in=3600 (OPTIONAL)\n  &iss=https://op (extension)
& uac - -> client

else 

ref over client, as: other reponse modes

end

hnote over client: Check validity of state\nand its association with the user session\n(protection against CSRF)
hnote over client: Check "iss" field (if given),\nprotection against mixup attacks

opt id_token in reponse_type

ref over client, uac: Process id_token (decrypt if necessary, validate)

hnote over client, uac: Check code against c_hash (protect against code substitution attacks)

opt token in response_type
hnote over client, uac: Check code against at_hash (protect against access_token substitution attacks)
end

end

|||

client -> as: **Token Request** (OAuth Access Token Request)\nHTTPS POST https://op/token (token_endpoint), urlencoded\nAuthorization: Basic … (client_id + client_secret) (or other authentication method, see token_endpoint_auth_method)\ngrant_type=authorization_code\n  &code=AC-XXXX\n  &redirect_uri=https%3A%2F%2Fclient%2Fcallback (REQUIRED, same as in request)\n  &code_verifier=CV-XXXXV (if code_challenge was used i.e. PKCE)

hnote over as: Check (client authentication,\nredirect_uri, code, etc)
hnote over as: Check code issued to client_id
opt code_challenge was sent in authentication request
  hnote over as: Check code_verifier=\ncode_challenge_method(code_challenge)
else
  break code_verifier was supplied
    note over as: Protection against PKCE downgrade attacks
  end
end
hnote over as: Revoke code (single use)

client <- - as: **Token Response** (OAuth Access Token Response)\nHTTPS 200, JSON\n"access_token":"AT-XXXX", (opaque)\n    (may have different security characteristics than the access_token returned in the authentication request eg. give access to more user information)\n"token_type":"bearer",\n"expires_in":3600\n"refresh_token":"RT-XXXX", (OPTIONAL, opaque)\n"scope":"scope1 scope2",\n"id_token": JWT (may contain more information than the id_token returned in the authentication response)

ref over client: Process id_token (decrypt if necessary, validate)

client -> uac: Restore application state (eg. target_link_uri)
& uac -> user

@enduml

PlantUML version 1.2022.13(Sat Nov 19 14:22:17 CET 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>